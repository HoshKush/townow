<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="board">
	 <resultMap type="BoardDTO" id="oneMap">
    	<result property="brd_id" column="brd_id"/>
    	<result property="title" column="title"/>
    	<result property="content" column="content"/>
    	<result property="email" column="email"/>
    	<result property="create_tiime" column="create_time"/>
    	<result property="update_time" column="update_time"/>
    	<result property="filename" column="filename"/>
    	<result property="filesize" column="filesize"/>
    	<result property="grp" column="grp"/>
    	<result property="ca_id" column="ca_id"/>
    	<result property="like"	column="like"/>
    	<result property="dislike"	column="dislike"/>
    	<result property="viewcount"	column="viewcount"/>
    	<result property="localdto.state" column="state"/>
    	<result property="localdto.city" column="city"/>
    	<result property="localdto.gu" column="gu"/>
    	<result property="localdto.dong" column="dong"/>
    	<result property="usersdto.nickname" column="nickname"/>
    </resultMap>
	<delete id="delete" parameterType="int">
		DELETE FROM board WHERE brd_id = #{pk}
	</delete>
	
	<select id="isWriter" parameterType="String" resultType="int">
		select count(*) from board where email = #{email}
	</select>
	
	<select id="hasGroup" parameterType="int" resultType="int">
	SELECT count(grpno) FROM board WHERE grpno = #{brd_id}
	</select>

	<insert id="createReply" parameterType="BoardDTO">
	INSERT INTO board(email, title, content, filename, filesize, loc_id, ca_id, create_time, ref, indent, ansno, refnum)
	VALUES(#{email}, #{title}, #{content}, #{filename, jdbcType=VARCHAR}, #{filesize, jdbcType=VARCHAR}, 
		#{loc_id}, #{ca_id}, unix_timestamp(), #{grp}, #{indent}+1, #{ansno}+1, #{brd_id})
	</insert>

	<update id="updateAnsno" parameterType="Map">
	UPDATE board SET ansno = ansno + 1 WHERE grp = #{grp} and ansno > #{ansno}
	</update>
	
	<select id="readReply" parameterType="int" resultType="BoardDTO">
	 SELECT title, grp, indent, ansno 
	 FROM board WHERE brd_id = #{brd_id}
	</select>
	
	<update id="update" parameterType="BoardDTO">
	UPDATE board SET
	update_time = unix_timestamp(),
	title = #{title},
	content = #{content}
	<if test="filename != null and !filename.equals('')">
	filename= #{filename},
	</if>
	 WHERE brd_id = #{brd_id}
	</update>
	<update id="viewcount" parameterType="int">
		UPDATE board SET
		viewcount = viewcount + 1
		WHERE brd_id = #{brd_id}
	</update>
	<update id="updateLike" parameterType="int">
		UPDATE board SET
		like = like + 1
		WHERE brd_id = #{brd_id}
	</update>
	
	<update id="updateDislike" parameterType="int">
		UPDATE board SET
		dislike = dislike + 1
		WHERE brd_id = #{brd_id}
	</update>
	
	<insert id="create" parameterType="BoardDTO">
		INSERT INTO board(
		email, title, content, filename, filesize, loc_id, ca_id, create_time)
		VALUES(
		#{email}, #{title}, #{content}, #{filename, jdbcType=VARCHAR}, #{filesize}, 
		#{loc_id}, #{ca_id}, unix_timestamp())
	</insert> 

	<select id="list" resultMap="oneMap" parameterType="Map">
		select
		title, nickname, date_format(create_time) time, filename, indent, like, dislike, viewcount, r
		from(
		select
		title, nickname, time, filename, indent, like, dislike, viewcount, rownum r
		from (
		select
		b.title title, u.nickname nickname, b.create_time time, b.filename filename, b.indent indent,
		b.like like, b.dislike dislike, b.viewcount viewcount
		from board b, users u
		<where>
			<if test="loc_id!=null">
			b.loc_id = #{loc_id} and
			</if>
			<if test="ca_id!=null">
			b.ca_id = #{ca_id}
			</if>
			<choose>
				<when test="col=='nickname'">
					and	name like '%'||#{word}||'%'
				</when>
				<when test="col=='subject'">
					and	subject like '%'||#{word}||'%'
				</when>
				<when test="col=='content'">
					and	content like '%'||#{word}||'%'
				</when>
				<otherwise>
					and	subject like '%'||#{word}||'%'
					or
					content like
					'%'||#{word}||'%'
				</otherwise>
			</choose>
		</where>
		ORDER BY grp DESC, ansno ASC
		)
		)                                                                            
   <![CDATA[                                                                        
   where r >= #{sno} and r <= ${eno}  
   ]]>
	</select>

	<select id="read" resultMap="oneMap" parameterType="int">
		select
		b.brd_id, b.title, b.content, b.filename, b.filesize, b.grp, b.email, b.date_format(create_time), b.date_format(update_time),
		b.ca_id, b.like, b.dislike, b.viewcount, u.nickname, l.state, l.city, l.gu, l.dong
		from board b, users u, local l
		where b.brd_id = #{pk} and b.email = u.email and b.loc_id = l.loc_id 
	</select>

	<select id="total" parameterType="Map" resultType="int">
		SELECT COUNT(*) FROM board, 
		<where>
			<if test="loc_id!=null">
			b.loc_id = #{loc_id} and
			</if>
			<if test="ca_id!=null">
			b.ca_id = #{ca_id}
			</if>
			<choose>
				<when test="col=='nickname'">
					and name like '%'||#{word}||'%'
				</when>
				<when test="col=='subject'">
					and subject like '%'||#{word}||'%'
				</when>
				<when test="col=='content'">
					and content like '%'||#{word}||'%'
				</when>
				<otherwise>
					and subject like '%'||#{word}||'%'
					or 
					content like '%'||#{word}||'%'
				</otherwise>
			</choose>
		</where>
	</select>
</mapper>